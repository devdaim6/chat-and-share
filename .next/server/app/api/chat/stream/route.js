(()=>{var e={};e.id=480,e.ids=[480],e.modules={20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},79348:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30412:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},27790:e=>{"use strict";e.exports=require("assert")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},98216:e=>{"use strict";e.exports=require("net")},82452:e=>{"use strict";e.exports=require("tls")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},61272:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>g,routeModule:()=>d,serverHooks:()=>m,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>l});var n={};r.r(n),r.d(n,{GET:()=>u});var s=r(88797),a=r(10042),o=r(58492),i=r(91507),c=r(62085);async function u(e){let{searchParams:t}=new URL(e.url),r=t.get("roomId");if(!r)return new Response("Room ID is required",{status:400});try{if(!await c.WK.findOne({roomId:r}))return new Response("Room not found",{status:404})}catch(e){return console.error("Database error:",e),new Response("Internal server error",{status:500})}let n=new TextEncoder,s=new TransformStream,a=s.writable.getWriter(),o=`chat-consumer-${r}-${Date.now()}`,u=(0,i.zD)(o),d=(0,i.Mh)(r);try{return await u.connect(),await u.subscribe({topic:d,fromBeginning:!1}),await u.run({eachMessage:async({message:e})=>{if(e.value){let t=`data: ${e.value.toString()}

`;await a.write(n.encode(t))}}}),e.signal.addEventListener("abort",async()=>{try{await u.disconnect()}catch(e){console.error("Error disconnecting consumer:",e)}}),new Response(s.readable,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}catch(e){console.error("Kafka error:",e);try{await u.disconnect()}catch(e){console.error("Error disconnecting consumer:",e)}return new Response("Error establishing connection",{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/chat/stream/route",pathname:"/api/chat/stream",filename:"route",bundlePath:"app/api/chat/stream/route"},resolvedPagePath:"C:\\Users\\Administrator\\Desktop\\CHAt\\chat-and-share\\app\\api\\chat\\stream\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:p,workUnitAsyncStorage:l,serverHooks:m}=d;function g(){return(0,o.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:l})}},78031:()=>{},35303:()=>{},91507:(e,t,r)=>{"use strict";r.d(t,{Mh:()=>d,bG:()=>u,zD:()=>c});var n=r(47278);let s=[process.env.KAFKA_BROKER_URL],a=new n.Kafka({clientId:"chat-app",brokers:s,retry:{initialRetryTime:100,retries:8}}),o=null;async function i(){return o||(o=a.producer(),await o.connect()),o}function c(e){return a.consumer({groupId:e})}async function u(e,t){let r=await i();await r.send({topic:e,messages:[{value:JSON.stringify(t)}]})}function d(e){return`chat-room-${e}`}},62085:(e,t,r)=>{"use strict";r.d(t,{WK:()=>u,Ee:()=>c,uD:()=>a});let n=require("mongoose");var s=r.n(n);let a=async()=>{try{0===s().connection.readyState&&(await s().connect(process.env.MONGODB_URI),console.log("Connected to MongoDB"))}catch(e){throw console.error("MongoDB connection error:",e),e}},o=new(s()).Schema({imageId:{type:String,required:!0,unique:!0},message:{type:String},imageData:{type:String,required:!0},scheduledForDeletion:{type:Boolean,default:!1},createdAt:{type:Date,default:Date.now}}),i=new(s()).Schema({roomId:{type:String,required:!0,unique:!0},messages:[{sender:{type:String,required:!0},message:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],createdAt:{type:Date,default:Date.now}}),c=s().models.Image||s().model("Image",o),u=s().models.ChatRoom||s().model("ChatRoom",i)},88797:(e,t,r)=>{"use strict";e.exports=r(30517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[492,278],()=>r(61272));module.exports=n})();